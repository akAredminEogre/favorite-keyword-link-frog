# やりたかったこと、経緯
- TypeScript + React + Vite で Chrome 拡張機能を作りたい
- その開発環境を WSL2 上に Docker で構築したい
- 現行の crxjs はライブラリの更新が滞っているため、wxt を使ってみたい
- しかし、wxt を Docker コンテナ上で動かしている知見がない（技術的には有用でないのかも）

# 前提
- Windows 11
- WSL2
- 空のリポジトリが作成済み
- Docker、Docker Compose がインストール済み

# 最終成果物とその解説
## ディレクトリ構造(抜粋)

```
.
├── Dockerfile
├── docker-compose.yml
└── host-frontend-root # コンテナの/opt/frontend-container-app-rootにマウントされるディレクトリ
    └── frontend-src-root # wxtで作成したプロジェクト
        ├── .output # chromeから読み込むディレクトリ
        ├── .wxt 
        ├── assets
        ├── entrypoints # 開発で編集するファイル
        ├── package-lock.json
        ├── package.json
        ├── public
        ├── tsconfig.json
        └── wxt.config.ts # docker対応のために編集
```

```Dockerfile
# 実際には wxt の初期化を行うため、最初はいくつかのコードをコメントアウトしている
FROM node:23.0-alpine3.19

WORKDIR /opt/frontend-container-app-root/frontend-src-root

# Chromium のインストール
RUN apk add --no-cache \
  chromium

COPY ./host-frontend-root/frontend-src-root /opt/frontend-container-app-root/frontend-src-root

RUN npm install

```

```docker-compose.yml
services:
  frontend:
    image: frontend-image
    build: .
    restart: always
    tty: true
    volumes:
      - ./host-frontend-root:/opt/frontend-container-app-root/
    environment:
      - HOST=localhost
    network_mode: host
```

```typescript:wxt.config.ts
import { defineConfig } from 'wxt';

// See https://wxt.dev/api/config.html
export default defineConfig({
  extensionApi: 'chrome',
  modules: ['@wxt-dev/module-react'],

  dev: {
    server: {
      hostname: 'localhost',
      port: 3000,
    }
  },
  runner: {
    disabled: true,
  },
  vite:() =>  ({
    server: {
      host: 'localhost',
      port: 3000,
      strictPort: true, 
      hmr: {
        port: 3000,
      }
    }
  }),
});
```

# やったこと

## 初期ディレクトリ、ファイル構成
プロジェクトルートにフォルダを作成
```
mkdir host-frontend-root
```

プロジェクトルートに Dockerfile、docker-compose.yml を作成
```
echo "FROM node:23.0-alpine3.19" > Dockerfile
echo "services:" > docker-compose.yml
```

この時点のディレクトリ構造は下記の通り
```
tree -I .
.
├── Dockerfile
├── README.md
├── docker-compose.yml
└── host-frontend-root

2 directories, 3 files

```

## 初期コンテナ作成
あとで使う箇所をコメントアウトしておく
```Dockerfile
FROM node:23.0-alpine3.19

WORKDIR /opt/frontend-container-app-root/frontend-src-root

# Chromium のインストール
RUN apk add --no-cache \
  chromium

# COPY ./host-frontend-root/frontend-src-root /opt/frontend-container-app-root/frontend-src-root

# RUN npm install
```

```docker-compose.yml
services:
  frontend:
    image: frontend-image
    build: .
    restart: always
    tty: true
    volumes:
      - ./host-frontend-root:/opt/frontend-container-app-root/
    environment:
      - HOST=localhost
    network_mode: host
```

コンテナを起動する
```bash
docker compose build --no-cache && docker compose up -d && docker compose ps
```

## wxtを使ってプロジェクトを作成
VS Code のリモートエクスプローラーで起動したコンテナに接続する

```bash
# pwd
/opt/frontend-container-app-root
```

wxt を使ってプロジェクトを作成する
```bash
npx wxt@latest init frontend-src-root
```
を実行。下記のようなログになっていることを確認
(抜粋)

```
/opt/frontend-container-app-root # npx wxt@latest init frontend-src-root
WXT 0.19.23
ℹ Initalizing new project
✔ Choose a template › react
✔ Package Manager › npm
✔ Downloading template

✨ WXT project created with the react template.

Next steps:
  1. cd frontend-src-root
  2. npm install
```

```bash
/opt/frontend-container-app-root # cd frontend-src-root
/opt/frontend-container-app-root/frontend-src-root # npm install

> wxt-react-starter@0.0.0 postinstall
> wxt prepare

WXT 0.19.23
types...
✔ Finished in 3.013 s

added 546 packages in 8m

148 packages are looking for funding
  run `npm fund` for details
```

権限の修正
```
sudo chown -R (wslユーザー名):(wslユーザー名) frontend-src-root/
```

wxt.config.ts を編集する
```typescript:wxt.config.ts
import { defineConfig } from 'wxt';

// See https://wxt.dev/api/config.html
export default defineConfig({
  extensionApi: 'chrome',
  modules: ['@wxt-dev/module-react'],

  dev: {
    server: {
      hostname: 'localhost',
      port: 3000,
    }
  },
  runner: {
    disabled: true,
  },
  vite: () => ({
    server: {
      host: 'localhost',
      port: 3000,
      strictPort: true, 
      hmr: {
        port: 3000,
      }
    }
  }),
});
```

```bash
/opt/frontend-container-app-root/frontend-src-root # npm run dev

> wxt-react-starter@0.0.0 dev
> wxt

WXT 0.19.23

✔ Started dev server @ http://localhost:3000
ℹ Pre-rendering chrome-mv3 for development with Vite 6.0.7
✔ Built extension in 1.747 s
  ├─ .output/chrome-mv3/manifest.json               1.05 kB 
  ├─ .output/chrome-mv3/popup.html                  744 B   
  ├─ .output/chrome-mv3/background.js               19.96 kB
  ├─ .output/chrome-mv3/chunks/popup-BxzUToPe.js    8.24 kB 
  ├─ .output/chrome-mv3/content-scripts/content.js  36.77 kB
  ├─ .output/chrome-mv3/icon/128.png                3.07 kB 
  ├─ .output/chrome-mv3/icon/16.png                 559 B   
  ├─ .output/chrome-mv3/icon/32.png                 916 B   
  ├─ .output/chrome-mv3/icon/48.png                 1.33 kB 
  ├─ .output/chrome-mv3/icon/96.png                 2.37 kB 
  └─ .output/chrome-mv3/wxt.svg                     1.07 kB 
Σ Total size: 76.08 kB                                               
ℹ Load ".output/chrome-mv3" as an unpacked extension manually 
```

Chrome で下記を開く  
chrome://extensions/ ＞ パッケージ化されていない拡張機能を読み込む  
\\wsl.localhost\(Ubuntuのディストリビューション)\home\(ユーザー名)\(プロジェクトルート)\host-frontend-root\frontend-src-root\.output\chrome-mv3

スクショ

初期画面が表示される。カウントができることを確認し、ホットリロードが効いていることを確認。

リモートエクスプローラーを閉じて、ここまでを一旦コミットする

## Dockerfile による永続化
```Dockerfile
FROM node:23.0-alpine3.19

WORKDIR /opt/frontend-container-app-root/frontend-src-root

# Chromium のインストール
RUN apk add --no-cache \
  chromium

COPY ./host-frontend-root/frontend-src-root /opt/frontend-container-app-root/frontend-src-root

RUN npm install
```

再ビルド
```bash
docker compose build --no-cache && docker compose up -d && docker compose ps
```

docker コマンドでコンテナに接続して、npm run dev を実行する
```bash
docker compose exec frontend npm run dev
```

どのようにポップアップとホットリロードが動作するかを確認する