# 

# やりたかったこと
- TypeScript + React + Viteでchrome拡張機能を作りたい
- その開発環境をDockerで構築したい
- 


# 偉大なる参考記事

ゼロから始めるVSCode × Docker × React × TypeScript開発環境構築 #Docker - Qiita
https://qiita.com/kotattsu3/items/386e34028e41051cc0f7

Vite + JavaScript + CRXJS で拡張機能の開発テンプレート
https://zenn.dev/dotdotdot/articles/1866e178ab4085


# 最終成果物とその解説



# やったこと

## phase1 最も簡素なコンテナを構築

先行記事を参考に、リポジトリルート直下に簡素なDockerfileとdocker-compose.ymlを作成した。

```Dockerfile
FROM node:18-alpine

WORKDIR /opt/react-test-app
```

```docker-compose.yml
services:
  test-app:
    image: test-app
    container_name: test-app
    build: .
    restart: always
    tty: true
    volumes:
      - ./react-test-app:/opt/react-test-app
```

作成後、下記コマンドでコンテナを起動
```
docker compose up -d --build && docker compose ps
```
> VSCodeのリモートエクスプローラーでコンテナが見えるようになっているはずなので立ち上げます。
> 空のreact-test-appが作業ディレクトリになっているはずです。

VSCodeの左サイドバーからリモートエクスプローラーのアイコンをクリックし、
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3862473/35235f5c-93d0-7cee-4968-d4cf8e135326.png)
`開発コンテナー`の中から今ビルドしたコンテナを選択

空の`react-test-app`が存在することを確認
```
/opt/react-test-app # ls -la
total 4
drwxr-xr-x    2 root     root            64 Sep 22 21:43 .
drwxr-xr-x    1 root     root          4096 Sep 23 19:44 ..
```
この時点ではこれだけ確認できれば良い。
(localhostでの確認はまだ)

次のphaseではコンテナ外の作業になるので、リモートエクスプローラーを開いたVSCodeの左下のアイコン？？
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3862473/458c7ea9-e7c0-92be-42f4-5e0b01a6a83e.png)
をクリックして、

`リモート接続を終了する`をクリック
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3862473/b4fa0518-095c-d90c-c61d-bd86f6d20a47.png)


## phase2 ディレクトリの変更とdockerignore

ホスト側で、リポジトリルート直下の`react-test-app`の空フォルダを削除。

さらにDocker関係の2ファイルを下記のように修正した。

本質的には意味はないが、ホストとコンテナ側の関係、yml表記で使われる値の対応がわかっていなかったので、それをわかりやすくするように変更した。

```Dockerfile
FROM node:18-alpine

WORKDIR /opt/frontend-container-app-root/
```

```docker-compose.yml
frontend:
    image: frontend-image
    container_name: frontend-container
    build: .
    restart: always
    tty: true
    volumes:
      - ./host-frontend-root:/opt/frontend-container-app-root/
```

またそれらと同じ階層に.dockerignoreを作成する

```.dockerignore
.DS_Store
```
これによって、




再ビルド
```
docker compose down --rmi all --volumes --remove-orphans && docker system prune -f
 && docker compose build --no-cache && docker compose up -d && docker compose ps
```

リモートエクスプローラーでコンテナに入る
WORKDIRで指定した/opt/frontend-container-app-root/の空のディレクトリが作成されていることが確認できれば良い



phase01とのディレクトリの対応は下記

host-frontend-root
frontend-container-app-root

phase01と同様に、

```
/opt/frontend-container-app-root # ls -la
total 4
drwxr-xr-x    2 root     root            64 Sep 24 20:39 .
drwxr-xr-x    1 root     root          4096 Sep 25 20:41 ..
```
でからディレクトリになっていることを確認できればよい。




## phase03. Vite + React + TypeScriptのプロジェクトを作成
ここから、Vite用のコマンド実行のため、先行記事とはやや異なってくる。

リモートエクスプローラーを使い、コンテナ内で下記コマンド実行を行った。






https://crxjs.dev/vite-plugin/getting-started/react/create-project#create-a-project

```
/opt/frontend-container-app-root # npm init vite@^2.9.4 frontend-src-root
Need to install the following packages:
create-vite@2.9.5
Ok to proceed? (y) y


> npx
> cva frontend-src-root

✔ Select a framework: › react
✔ Select a variant: › react-ts

Scaffolding project in /opt/frontend-container-app-root/frontend-src-root...

Done. Now run:

  cd frontend-src-root
  npm install
  npm run dev

npm notice
npm notice New minor version of npm available! 10.7.0 -> 10.9.0
npm notice Changelog: https://github.com/npm/cli/releases/tag/v10.9.0
npm notice To update run: npm install -g npm@10.9.0
npm notice
```
frontend-src-rootは作成されるディレクトリ名。


- [ ] 公式ドキュメント引っ張る


サジェストされたコマンドを組み合わせて実行する



```

```

ログにある通り、http://localhost:5173/ にアクセスすると

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3862473/9ae4b868-9c9f-98e8-b2c9-9c31bb501d18.png)
ブラウザでViteとReactのトップ画面が出る

ここまで確認できたら、一旦リモートエクスプローラーを終了し、コンテナを停止する

- [ ] ちゃんと意識してなかったポイント
    - [ ] packages.jsonの場所

# phase 04. コマンドの永続化、vite設定

現状ではコンテナを起動するたびに
```
cd frontend-src-root && npm install -g npm@10.8.3 && npm install && npm run dev
```
を実行する必要があるので、これを永続化する

```Dockerfile:Dockerfile
FROM node:18-alpine

WORKDIR /opt/frontend-container-app-root/frontend-src-root

COPY ./host-frontend-root/frontend-src-root /opt/frontend-container-app-root/frontend-src-root

RUN npm install

CMD ["npm", "run", "dev"]
```

以下、解説
```
+ WORKDIR /opt/frontend-container-app-root/frontend-src-root
```
cd に相当

```
COPY ./host-frontend-root/frontend-src-root/package*.json /opt/frontend-container-app-root/frontend-src-root

RUN npm install
```
phase 02で実行した npm installに相当
WORKDIRで移動したコンテナ内ディレクトリで実行されることになる

実行にはpackage.jsonが必要になるので、COPYコマンドでホスト側からコンテナ側に移動する

```docker-compose.yml
services:
  frontend:
    image: frontend-image
    container_name: frontend-container
    build: .
    restart: always
    tty: true
    volumes:
      - ./host-frontend-root/frontend-src-root:/opt/frontend-container-app-root/frontend-src-root
```
同期されるvolumesを、ソースルートに限定

これで再ビルドすれば先ほどと同じ用にvite + reactの画面がでそうだが、実際には失敗する

viteの設定
```
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  server: {
    host: '0.0.0.0', // サーバーのバインドアドレスを設定
    port: 5173,      // ポート番号を設定（必要に応じて変更）
    strictPort: true, // ポートが既に使用されている場合にエラーをスロー
    hmr: {
      port: 5173,    // HMR が使用するポートを設定
    }
  }
})

```

さらにこの設定をdocker-compose.ymlにも反映する
```yml:docker-compose.yml
services:
  frontend:
    image: frontend-image
    container_name: frontend-container
    build: .
    restart: always
    tty: true
    volumes:
      - ./host-frontend-root/frontend-src-root:/opt/frontend-container-app-root/frontend-src-root
    ports:
      - "5173:5173"  # ポートフォワーディングの設定
    environment:
      - HOST=0.0.0.0  # サーバーのバインドアドレスを設定
```

これでリビルド、コンテナ再起動して、ブラウザでViteとReactのトップ画面が出る

また、
`host-frontend-root/frontend-src-root/src/App.tsx`を適当に変更して、それが即座に反映される＝ホットモジュールリロードが行われていることを確認する







# phase05 chrome拡張開発のための設定


## crxjsプラグインをインストール
再びリモートエクスプローラーからコンテナに入り、package.jsonがあるディレクトリに移動

```
cd frontend-src-root/
```


下記コマンドを実行
公式で最新バージョン確認

```
npm i @crxjs/vite-plugin@latest
```

```
/opt/frontend-container-app-root/frontend-src-root # npm i @crxjs/vite-plugin@latest
npm error code ERESOLVE
npm error ERESOLVE unable to resolve dependency tree
npm error
npm error While resolving: frontend-src-root@0.0.0
npm error Found: vite@5.4.9
npm error node_modules/vite
npm error   dev vite@"^5.4.1" from the root project
npm error
npm error Could not resolve dependency:
npm error peer vite@"^2.9.0" from @crxjs/vite-plugin@1.0.14
npm error node_modules/@crxjs/vite-plugin
npm error   dev @crxjs/vite-plugin@"1.0.14" from the root project
npm error
npm error Fix the upstream dependency conflict, or retry
npm error this command with --force or --legacy-peer-deps
npm error to accept an incorrect (and potentially broken) dependency resolution.
npm error
npm error
npm error For a full report see:
npm error /root/.npm/_logs/2024-10-17T04_50_20_151Z-eresolve-report.txt

npm error A complete log of this run can be found in: /root/.npm/_logs/2024-10-17T04_50_20_151Z-debug-0.log
```

## manifest.jsonファイルを作成


```json:host-frontend-root/frontend-src-root/manifest.json
{
  "manifest_version": 3,
  "name": "なんでもよい",
  "version": "1.0.0",
  "action": { "default_popup": "index.html" }
}
```

## 2. vite.config.tsをchrome拡張機能用に習性
vite.config.tsを修正する。
```typescript:vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react-swc'
import { crx } from '@crxjs/vite-plugin'
import manifest from './manifest.json'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react(), crx({ manifest })],
  server: {
    host: '0.0.0.0', // サーバーのバインドアドレスを設定
    port: 5173,      // ポート番号を設定（必要に応じて変更）
    strictPort: true, // ポートが既に使用されている場合にエラーをスロー
    hmr: {
      port: 5173,    // HMR が使用するポートを設定
    }
  }
})

```

## 3. distディレクトリの生成を確認
前phaseのコンテナ起動からそのまま作業していれば、
`host-frontend-root/frontend-src-root/dist`ディレクトリが生成されているはずである

なければ、コンテナから`npm run dev`を実行で生成される

ソース・ファイルがビルドされる

## 4. distディレクトリを拡張機能として読み込み

https://zenn.dev/dotdotdot/articles/1866e178ab4085#7.-%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF

の通り

ポップアップで確認画面が表示される

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3862473/bab6d3ff-5b0e-2663-a25d-7f1ba41070b3.png)


!!!! "@crxjs/vite-plugin": "2.0.0-beta.25",　を解決

ほっとリロードを確認

# phase06 コンテナ関係ファイルのリファクタリング

パスの繰り返しが多いので下記のようにリファクタリングする
```Dockerfile:Dockerfile

```


# 参考になりそうな記事
【TypeScript】ReactとCRXJS Vite Pluginで作るChrome拡張機能
https://zenn.dev/7oh/scraps/98d5cdcceb9bd8


Chrome ExtensionsをVite + TypeScriptで開発する - ひよこまめ
https://blog.chick-p.work/blog/chrome-extention-with-vite/


CRXJS Vite Pluginを使って爆速でChrome拡張機能を作るチュートリアル(V3対応) | DevelopersIO
https://dev.classmethod.jp/articles/eetann-chrome-extension-by-crxjs/

CRXJSを使ってReact(Vite+Docker)でChrome拡張を開発してみる
https://zenn.dev/mk668a/articles/118c49bd25078a



